<script>
    // --- Map data ---
    const nameMap = { // Using standard English names
      "AL": "Albania", "AT": "Austria", "BE": "Belgium", "BG": "Bulgaria", "HR": "Croatia",
      "CY": "Cyprus", "CZ": "Czech Republic", "DK": "Denmark", "EE": "Estonia", "FI": "Finland",
      "FR": "France", "DE": "Germany", "GR": "Greece", "HU": "Hungary", "IS": "Iceland",
      "IE": "Ireland", "IT": "Italy", "LV": "Latvia", "LT": "Lithuania", "LU": "Luxembourg",
      "MT": "Malta", "NL": "Netherlands", "NO": "Norway", "PL": "Poland", "PT": "Portugal",
      "RO": "Romania", "SK": "Slovakia", "SI": "Slovenia", "ES": "Spain", "SE": "Sweden",
      "CH": "Switzerland", "GB": "United Kingdom", "UA": "Ukraine", "RS": "Serbia", "BA": "Bosnia and Herzegovina",
      "MD": "Moldova", "MK": "North Macedonia", "BY": "Belarus", "RU": "Russia", "TR": "Turkey",
      "LI": "Liechtenstein", "AD": "Andorra", "MC": "Monaco", "ME": "Montenegro", "SM": "San Marino", "VA": "Vatican City",
      "AZ": "Azerbaijan", "AM": "Armenia", "GE": "Georgia"
      // Add others if needed based on your TopoJSON
    };

    // --- D3 Setup ---
    const svg = d3.select('svg');

    // ***** ADJUSTED PROJECTION *****
    const projection = d3.geoMercator()
      .center([18, 50]) // Lowered latitude (e.g., 50 instead of 55), adjusted longitude slightly
      .scale(480)      // Slightly reduced scale (e.g., 480 instead of 500) to fit more vertically
      .translate([450, 225]); // Centered Y translation in 900x450 viewBox (450 / 2 = 225)
    // ******************************

    const pathGenerator = d3.geoPath().projection(projection);

    // --- Game State Variables ---
    let selectedCountryData = null;
    let score = 0;
    let attempts = 0;
    let correctGuesses = 0;
    let totalCountries = 0;

    // --- DOM Element Selections ---
    const countryListElement = d3.select('#country-list');
    const feedbackElement = d3.select('#feedback');
    const scoreElement = d3.select('#score');
    const attemptsElement = d3.select('#attempts');
    const victoryMessageElement = d3.select('#victory-message');
    const restartButton = d3.select('#restart-button');

    // --- Load Map Data and Initialize Game ---
    d3.json('data/europe.topojson').then(topoData => {
      // Ensure the object name 'europe' matches your file structure
      if (!topoData.objects.europe) {
          console.error("TopoJSON file structure error: 'objects.europe' not found.");
          feedbackElement.text("Error: Invalid map data structure.").classed('error', true);
          return; // Stop execution if data structure is wrong
      }
      const countryFeatures = topojson.feature(topoData, topoData.objects.europe).features;

      const validCountries = countryFeatures.filter(d => d.id && nameMap[d.id]); // Ensure ID exists and is in nameMap
      totalCountries = validCountries.length;

       if (totalCountries === 0) {
           console.error("No valid countries found matching the nameMap.");
           feedbackElement.text("Error: No valid countries found in map data.").classed('error', true);
           return;
       }

       // --- Draw Map Paths ---
       const countryPaths = svg.selectAll('path.country')
         .data(validCountries, d => d.id)
         .enter().append('path')
         .attr('class', 'country')
         .attr('d', pathGenerator) // Path generator uses the updated projection
         .attr('id', d => `map-${d.id}`)
         .on('click', handleMapClick);

      // --- Populate Country List ---
      const countryListData = validCountries.map(d => ({
        id: d.id,
        name: nameMap[d.id]
      })).sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically by name

      const countryListItems = countryListElement.selectAll('li')
        .data(countryListData, d => d.id)
        .enter().append('li')
        .attr('id', d => `list-${d.id}`)
        .text(d => d.name)
        .on('click', handleListClick);

      // --- Initialize Scoreboard ---
      updateScoreboard();

    }).catch(error => {
        console.error('Error loading or processing TopoJSON:', error);
        feedbackElement.text('Error loading map data. Check console.').classed('error', true);
    });

    // --- Event Handlers ---
    // (Handlers remain the same as previous version)
    function handleListClick(d) {
      const listItem = d3.select(this);
      if (listItem.classed('matched')) return;

      countryListElement.selectAll('li').classed('selected', false);
      listItem.classed('selected', true);
      selectedCountryData = { id: d.id, name: d.name, element: listItem };
      feedbackElement.text('').classed('error', false).classed('correct', false);
    }

    function handleMapClick(d) {
      const clickedPath = d3.select(this);
      if (clickedPath.classed('guessed')) return;

      if (selectedCountryData) {
        attempts++;
        const correctId = selectedCountryData.id;
        const clickedId = d.id;
        const clickedName = nameMap[clickedId] || "this area";

        if (clickedId === correctId) {
          score += 10;
          correctGuesses++;
          feedbackElement.text('Correct!').classed('correct', true).classed('error', false);
          clickedPath.classed('guessed', true).style('pointer-events', 'none');
          selectedCountryData.element.classed('matched', true)
                                   .classed('selected', false)
                                   .on('click', null);
          selectedCountryData = null;
          if (correctGuesses === totalCountries) {
            victoryMessageElement
              .text(`ðŸŽ‰ You won! Final score: ${score} in ${attempts} attempts.`)
              .style('display', 'block');
          }
        } else {
          feedbackElement.text(`Incorrect. That was ${clickedName}. Try again.`).classed('error', true).classed('correct', false);
        }
        updateScoreboard();
      } else {
        feedbackElement.text('Please select a country name from the list first.').classed('error', true).classed('correct', false);
      }
    }

    // --- Update UI Functions ---
    function updateScoreboard() {
      scoreElement.text(score);
      attemptsElement.text(attempts);
    }

    // --- Restart Button ---
    restartButton.on('click', () => location.reload());

  </script>